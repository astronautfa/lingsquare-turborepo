import{a as P}from"./vidstack-BAZHLC3O.js";import{a as u}from"./vidstack-WJVXB6YB.js";import{b}from"./vidstack-KCALJS55.js";import{B as L,a as C,d as r,y as N}from"./vidstack-4WUVJWEQ.js";import{F as o,I as E,L as A,a as T,ca as _,f as h,g as S,k,n as M,r as x,x as a}from"./vidstack-XC7WIXLW.js";var c=null,l=[],m=[];function f(){return c??=new AudioContext}function D(){let n=f(),t=n.createGain();return t.connect(n.destination),l.push(t),t}function w(n,t){let e=f(),i=e.createMediaElementSource(n);return t&&i.connect(t),m.push(i),i}function G(n){let t=l.indexOf(n);t!==-1&&(l.splice(t,1),n.disconnect(),$())}function V(n){let t=m.indexOf(n);t!==-1&&(m.splice(t,1),n.disconnect(),$())}function $(){c&&l.length===0&&m.length===0&&c.close().then(()=>{c=null})}var p=class{#a;#t;#i=null;#s=null;get currentGain(){return this.#i?.gain?.value??null}get supported(){return!0}constructor(t,e){this.#a=t,this.#t=e}setGain(t){let e=this.currentGain;if(t!==this.currentGain){if(t===1&&e!==1){this.removeGain();return}this.#i||(this.#i=D(),this.#s&&this.#s.connect(this.#i)),this.#s||(this.#s=w(this.#a,this.#i)),this.#i.gain.value=t,this.#t(t)}}removeGain(){this.#i&&(this.#s&&this.#s.connect(f().destination),this.#r(),this.#t(null))}destroy(){this.#o(),this.#r()}#o(){if(this.#s)try{V(this.#s)}catch{}finally{this.#s=null}}#r(){if(this.#i)try{G(this.#i)}catch{}finally{this.#i=null}}};var I=["focus","blur","visibilitychange","pageshow","pagehide"],v=class{#a=E(H());#t=E(document.visibilityState);#i;connect(){for(let t of I)a(window,t,this.#s.bind(this));r&&a(window,"beforeunload",t=>{this.#i=setTimeout(()=>{t.defaultPrevented||t.returnValue.length>0||(this.#a.set("hidden"),this.#t.set("hidden"))},0)})}get pageState(){return this.#a()}get visibility(){return this.#t()}#s(t){r&&window.clearTimeout(this.#i),(t.type!=="blur"||this.#a()==="active")&&(this.#a.set(H(t)),this.#t.set(document.visibilityState=="hidden"?"hidden":"visible"))}};function H(n){return n?.type==="blur"||document.visibilityState==="hidden"?"hidden":document.hasFocus()?"active":"passive"}var y=class{#a;#t;#i=_();#s=!1;#o=!1;#r=!1;#d=new P(this.#v.bind(this));#u=new v;get#e(){return this.#a.media}constructor(t,e){this.#a=t,this.#t=e,this.#y(),this.#u.connect(),A(this.#w.bind(this)),h(this.#p.bind(this))}#p(){this.#o=!1,this.#r=!1,this.#d.stop(),this.#i.empty()}#c=0;#l=-1;#v(){let t=this.#e.currentTime;!(r&&t-this.#l<.35)&&this.#c!==t&&(this.#h(t),this.#c=t)}#y(){this.#n("loadstart",this.#T),this.#n("abort",this.#f),this.#n("emptied",this.#S),this.#n("error",this.#B),this.#n("volumechange",this.#$)}#g(){this.#o||(this.#i.add(this.#n("loadeddata",this.#k),this.#n("loadedmetadata",this.#M),this.#n("canplay",this.#_),this.#n("canplaythrough",this.#C),this.#n("durationchange",this.#V),this.#n("play",this.#x),this.#n("progress",this.#I),this.#n("stalled",this.#L),this.#n("suspend",this.#O),this.#n("ratechange",this.#F)),this.#o=!0)}#E(){this.#r||(this.#i.add(this.#n("pause",this.#A),this.#n("playing",this.#N),this.#n("seeked",this.#H),this.#n("seeking",this.#R),this.#n("ended",this.#D),this.#n("waiting",this.#P)),this.#r=!0)}#b=void 0;#U=void 0;#n(t,e){return a(this.#e,t,e.bind(this))}#j(t){}#h(t,e){let i=Math.min(t,this.#t.$state.seekableEnd());this.#t.notify("time-change",i,e)}#T(t){if(this.#e.networkState===3){this.#f(t);return}this.#g(),this.#t.notify("load-start",void 0,t)}#f(t){this.#t.notify("abort",void 0,t)}#S(){this.#t.notify("emptied",void 0,event)}#k(t){this.#t.notify("loaded-data",void 0,t)}#M(t){this.#c=0,this.#l=-1,this.#E(),this.#t.notify("loaded-metadata",void 0,t),(C||r&&N(this.#t.$state.source()))&&this.#t.delegate.ready(this.#m(),t)}#m(){return{provider:T(this.#t.$provider),duration:this.#e.duration,buffered:this.#e.buffered,seekable:this.#e.seekable}}#x(t){this.#t.$state.canPlay&&this.#t.notify("play",void 0,t)}#A(t){this.#e.readyState===1&&!this.#s||(this.#s=!1,this.#d.stop(),this.#t.notify("pause",void 0,t))}#_(t){this.#t.delegate.ready(this.#m(),t)}#C(t){this.#t.$state.started()||this.#t.notify("can-play-through",this.#m(),t)}#N(t){this.#e.paused||(this.#s=!1,this.#t.notify("playing",void 0,t),this.#d.start())}#L(t){this.#t.notify("stalled",void 0,t),this.#e.readyState<3&&(this.#s=!0,this.#t.notify("waiting",void 0,t))}#P(t){this.#e.readyState<3&&(this.#s=!0,this.#t.notify("waiting",void 0,t))}#D(t){this.#d.stop(),this.#h(this.#e.duration,t),this.#t.notify("end",void 0,t),this.#t.$state.loop()&&k(this.#e.controls)&&(this.#e.controls=!1)}#w(){let t=this.#t.$state.paused(),e=this.#u.visibility==="hidden";(t||e)&&a(this.#e,"timeupdate",this.#G.bind(this))}#G(t){this.#h(this.#e.currentTime,t)}#V(t){this.#t.$state.ended()&&this.#h(this.#e.duration,t),this.#t.notify("duration-change",this.#e.duration,t)}#$(t){let e={volume:this.#e.volume,muted:this.#e.muted};this.#t.notify("volume-change",e,t)}#H(t){this.#l=this.#e.currentTime,this.#h(this.#e.currentTime,t),this.#t.notify("seeked",this.#e.currentTime,t),Math.trunc(this.#e.currentTime)===Math.trunc(this.#e.duration)&&b(this.#e.duration)>b(this.#e.currentTime)&&(this.#h(this.#e.duration,t),this.#e.ended||this.#t.player.dispatch(new x("media-play-request",{trigger:t})))}#R(t){this.#t.notify("seeking",this.#e.currentTime,t)}#I(t){let e={buffered:this.#e.buffered,seekable:this.#e.seekable};this.#t.notify("progress",e,t)}#O(t){this.#t.notify("suspend",void 0,t)}#F(t){this.#t.notify("rate-change",this.#e.playbackRate,t)}#B(t){let e=this.#e.error;if(!e)return;let i={message:e.message,code:e.code,mediaError:e};this.#t.notify("error",i,t)}};var g=class{#a;#t;get#i(){return this.#a.media.audioTracks}constructor(t,e){this.#a=t,this.#t=e,this.#i.onaddtrack=this.#s.bind(this),this.#i.onremovetrack=this.#o.bind(this),this.#i.onchange=this.#r.bind(this),a(this.#t.audioTracks,"change",this.#u.bind(this))}#s(t){let e=t.track;if(e.label==="")return;let i=e.id.toString()||`native-audio-${this.#t.audioTracks.length}`,s={id:i,label:e.label,language:e.language,kind:e.kind,selected:!1};this.#t.audioTracks[u.add](s,t),e.enabled&&(s.selected=!0)}#o(t){let e=this.#t.audioTracks.getById(t.track.id);e&&this.#t.audioTracks[u.remove](e,t)}#r(t){let e=this.#d();if(!e)return;let i=this.#t.audioTracks.getById(e.id);i&&this.#t.audioTracks[u.select](i,!0,t)}#d(){return Array.from(this.#i).find(t=>t.enabled)}#u(t){let{current:e}=t.detail;if(!e)return;let i=this.#i.getTrackById(e.id);if(i){let s=this.#d();s&&(s.enabled=!1),i.enabled=!0}}};var R=class{constructor(t,e){this.media=t;this.ctx=e}scope=S();currentSrc=null;audioGain=new p(this.media,t=>{this.ctx.notify("audio-gain-change",t)});setup(){new y(this,this.ctx),"audioTracks"in this.media&&new g(this,this.ctx),h(()=>{this.audioGain.destroy(),this.media.srcObject=null,this.media.removeAttribute("src");for(let t of this.media.querySelectorAll("source"))t.remove();this.media.load()})}get type(){return""}setPlaybackRate(t){this.media.playbackRate=t}async play(){return this.media.play()}async pause(){return this.media.pause()}setMuted(t){this.media.muted=t}setVolume(t){this.media.volume=t}setCurrentTime(t){this.media.currentTime=t}setPlaysInline(t){o(this.media,"playsinline",t)}async loadSource({src:t,type:e},i){this.media.preload=i||"",L(t)?(this.removeSource(),this.media.srcObject=t):(this.media.srcObject=null,M(t)?e!=="?"?this.appendSource({src:t,type:e}):(this.removeSource(),this.media.src=this.#a(t)):(this.removeSource(),this.media.src=window.URL.createObjectURL(t))),this.media.load(),this.currentSrc={src:t,type:e}}appendSource(t,e){let i=this.media.querySelector("source[data-vds]"),s=i??document.createElement("source");o(s,"src",this.#a(t.src)),o(s,"type",t.type!=="?"?t.type:e),o(s,"data-vds",""),i||this.media.append(s)}removeSource(){this.media.querySelector("source[data-vds]")?.remove()}#a(t){let{clipStartTime:e,clipEndTime:i}=this.ctx.$state,s=e(),d=i();return s>0&&d>0?`${t}#t=${s},${d}`:s>0?`${t}#t=${s}`:d>0?`${t}#t=0,${d}`:t}};export{R as a};
