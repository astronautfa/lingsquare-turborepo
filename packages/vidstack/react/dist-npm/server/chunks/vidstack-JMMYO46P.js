import{a as D}from"./vidstack-EZSRPPZM.js";import{a as M}from"./vidstack-S4PU3EFK.js";import{a as v}from"./vidstack-ZSHM5QYX.js";import{a as y,f as x}from"./vidstack-3NDWMYL6.js";import{b as _,c as k}from"./vidstack-GIOYWYZF.js";import"./vidstack-E6RN3UOU.js";import{a as w}from"./vidstack-TBIJQY3V.js";import{c as C,m as T}from"./vidstack-E7FJTJF3.js";import"./vidstack-ISJILNRC.js";import{a as p}from"./vidstack-D22ZK42Y.js";import{B as g,W as H,a as u,m,q as d,s as b,u as E,v as l}from"./vidstack-DK4Y24W7.js";import"./vidstack-JGGQ3EWW.js";var V=o=>H(o),L=class{#i;#t;#e=null;#s=null;config={};#o=new Set;get instance(){return this.#e}constructor(t,e){this.#i=t,this.#t=e}setup(t){let{streamType:e}=this.#t.$state,i=u(e).includes("live"),r=u(e).includes("ll-");this.#e=new t({lowLatencyMode:r,backBufferLength:r?4:i?8:void 0,renderTextTracksNatively:!1,...this.config});let n=this.#c.bind(this);for(let s of Object.values(t.Events))this.#e.on(s,n);this.#e.on(t.Events.ERROR,this.#L.bind(this));for(let s of this.#o)s(this.#e);this.#t.player.dispatch("hls-instance",{detail:this.#e}),this.#e.attachMedia(this.#i),this.#e.on(t.Events.AUDIO_TRACK_SWITCHED,this.#h.bind(this)),this.#e.on(t.Events.LEVEL_SWITCHED,this.#u.bind(this)),this.#e.on(t.Events.LEVEL_LOADED,this.#p.bind(this)),this.#e.on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,this.#d.bind(this)),this.#e.on(t.Events.CUES_PARSED,this.#l.bind(this)),this.#t.qualities[v.enableAuto]=this.#S.bind(this),g(this.#t.qualities,"change",this.#m.bind(this)),g(this.#t.audioTracks,"change",this.#g.bind(this)),this.#s=E(this.#n.bind(this))}#r(t,e){return new l(V(t),{detail:e})}#n(){if(!this.#t.$state.live())return;let t=new w(this.#a.bind(this));return t.start(),t.stop.bind(t)}#a(){this.#t.$state.liveSyncPosition.set(this.#e?.liveSyncPosition??1/0)}#c(t,e){this.#t.player?.dispatch(this.#r(t,e))}#d(t,e){let i=this.#r(t,e),r=-1;for(let n=0;n<e.tracks.length;n++){let s=e.tracks[n],c=s.subtitleTrack??s.closedCaptions,h=new x({id:`hls-${s.kind}-${n}`,src:c?.url,label:s.label,language:c?.lang,kind:s.kind,default:s.default});h[y.readyState]=2,h[y.onModeChange]=()=>{h.mode==="showing"?(this.#e.subtitleTrack=n,r=n):r===n&&(this.#e.subtitleTrack=-1,r=-1)},this.#t.textTracks.add(h,i)}}#l(t,e){let i=this.#e?.subtitleTrack,r=this.#t.textTracks.getById(`hls-${e.type}-${i}`);if(!r)return;let n=this.#r(t,e);for(let s of e.cues)s.positionAlign="auto",r.addCue(s,n)}#h(t,e){let i=this.#t.audioTracks[e.id];if(i){let r=this.#r(t,e);this.#t.audioTracks[p.select](i,!0,r)}}#u(t,e){let i=this.#t.qualities[e.level];if(i){let r=this.#r(t,e);this.#t.qualities[p.select](i,!0,r)}}#p(t,e){if(this.#t.$state.canPlay())return;let{type:i,live:r,totalduration:n,targetduration:s}=e.details,c=this.#r(t,e);this.#t.notify("stream-type-change",r?i==="EVENT"&&Number.isFinite(n)&&s>=10?"live:dvr":"live":"on-demand",c),this.#t.notify("duration-change",n,c);let h=this.#e.media;this.#e.currentLevel===-1&&this.#t.qualities[v.setAuto](!0,c);for(let a of this.#e.audioTracks){let S={id:a.id.toString(),label:a.name,language:a.lang||"",kind:"main"};this.#t.audioTracks[p.add](S,c)}for(let a of this.#e.levels){let S={id:a.id?.toString()??a.height+"p",width:a.width,height:a.height,codec:a.codecSet,bitrate:a.bitrate};this.#t.qualities[p.add](S,c)}h.dispatchEvent(new l("canplay",{trigger:c}))}#L(t,e){if(e.fatal)switch(e.type){case"mediaError":this.#e?.recoverMediaError();break;default:this.#f(e.error);break}}#f(t){this.#t.notify("error",{message:t.message,code:1,error:t})}#S(){this.#e&&(this.#e.currentLevel=-1)}#m(){let{qualities:t}=this.#t;!this.#e||t.auto||(this.#e[t.switch+"Level"]=t.selectedIndex,C&&(this.#i.currentTime=this.#i.currentTime))}#g(){let{audioTracks:t}=this.#t;this.#e&&this.#e.audioTrack!==t.selectedIndex&&(this.#e.audioTrack=t.selectedIndex)}onInstance(t){return this.#o.add(t),()=>this.#o.delete(t)}loadSource(t){d(t.src)&&this.#e?.loadSource(t.src)}destroy(){this.#e?.destroy(),this.#e=null,this.#s?.(),this.#s=null}};var f=class{#i;#t;#e;constructor(t,e,i){this.#i=t,this.#t=e,this.#e=i,this.#s()}async#s(){let t={onLoadStart:this.#o.bind(this),onLoaded:this.#r.bind(this),onLoadError:this.#n.bind(this)},e=await $(this.#i,t);if(m(e)&&!d(this.#i)&&(e=await A(this.#i,t)),!e)return null;if(!e.isSupported()){let i="[vidstack] `hls.js` is not supported in this environment";return this.#t.player.dispatch(new l("hls-unsupported")),this.#t.notify("error",{message:i,code:4}),null}return e}#o(){this.#t.player.dispatch(new l("hls-lib-load-start"))}#r(t){this.#t.player.dispatch(new l("hls-lib-loaded",{detail:t})),this.#e(t)}#n(t){let e=M(t);this.#t.player.dispatch(new l("hls-lib-load-error",{detail:e})),this.#t.notify("error",{message:e.message,code:4,error:e})}};async function A(o,t={}){if(!m(o)){if(t.onLoadStart?.(),o.prototype&&o.prototype!==Function)return t.onLoaded?.(o),o;try{let e=(await o())?.default;if(e&&e.isSupported)t.onLoaded?.(e);else throw Error("");return e}catch(e){t.onLoadError?.(e)}}}async function $(o,t={}){if(d(o)){t.onLoadStart?.();try{if(await k(o),!b(window.Hls))throw Error("");let e=window.Hls;return t.onLoaded?.(e),e}catch(e){t.onLoadError?.(e)}}}var P="https://cdn.jsdelivr.net",I=class extends D{$$PROVIDER_TYPE="HLS";#i=null;#t=new L(this.video,this.ctx);get ctor(){return this.#i}get instance(){return this.#t.instance}static supported=T();get type(){return"hls"}get canLiveSync(){return!0}#e=`${P}/npm/hls.js@^1.5.0/dist/hls.min.js`;get config(){return this.#t.config}set config(t){this.#t.config=t}get library(){return this.#e}set library(t){this.#e=t}preconnect(){d(this.#e)&&_(this.#e)}setup(){super.setup(),new f(this.#e,this.ctx,t=>{this.#i=t,this.#t.setup(t),this.ctx.notify("provider-setup",this);let e=u(this.ctx.$state.source);e&&this.loadSource(e)})}async loadSource(t,e){if(!d(t.src)){this.removeSource();return}this.media.preload=e||"",this.appendSource(t,"application/x-mpegurl"),this.#t.loadSource(t),this.currentSrc=t}onInstance(t){let e=this.#t.instance;return e&&t(e),this.#t.onInstance(t)}destroy(){this.#t.destroy()}};export{I as HLSProvider};
