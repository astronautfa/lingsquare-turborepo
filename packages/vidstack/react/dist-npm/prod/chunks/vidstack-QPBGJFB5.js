import{a as T,b as u,c as _,d as x}from"./vidstack-UWTXLL5O.js";import{Ia as w}from"./vidstack-EWFRKCDB.js";import"./vidstack-K6RQTZRP.js";import"./vidstack-MDPL2QMH.js";import"./vidstack-YHRZY7KJ.js";import"./vidstack-5IOIYQ2Y.js";import"./vidstack-IMDQ4X5U.js";import"./vidstack-X63HW5FO.js";import{a as R}from"./vidstack-O5YRSEZK.js";import"./vidstack-ARJ2AQF3.js";import"./vidstack-7FJQKULN.js";import{$ as h,B as c,a as m,ba as F,c as p,ea as k,g as v,h as d,s as l,u as y}from"./vidstack-7GZB5QIO.js";import"./vidstack-L4FAE4B5.js";import*as s from"react";import{Internals as f}from"remotion";var b=class{#e;#h;#d;#l=F();#i=0;#s=0;#a=1;#m=!1;#r=-1;#u=-1;#o=0;#c=!1;get frame(){return this.#i}set frame(t){this.#i=t,this.#h(t)}constructor(t,e,i){this.#e=t,this.#h=e,this.#d=i,this.#i=t.initialFrame??0,this.#l.add(c(document,"visibilitychange",this.#b.bind(this)))}play(){this.#s=0,this.#m=!0,this.#o=performance.now(),this.#f()}stop(){this.#m=!1,this.#r>=0&&(cancelAnimationFrame(this.#r),this.#r=-1),this.#u>=0&&(clearTimeout(this.#u),this.#u=-1)}setPlaybackRate(t){this.#a=t}destroy(){this.#l.empty(),this.stop()}#n(){let{nextFrame:t,framesToAdvance:e,ended:i}=this.#y();this.#s+=e,t!==this.#i&&(this.#h(t),this.#i=t),i&&(this.#i=this.#e.outFrame,this.stop(),this.#d())}#f=()=>{this.#n(),this.#m&&this.#t(this.#f)};#t(t){this.#c?this.#u=window.setTimeout(t,1e3/this.#e.fps):this.#r=requestAnimationFrame(t)}#y(){let t=this.#a<0?Math.ceil:Math.floor,e=performance.now()-this.#o,i=t(e*this.#a/(1e3/this.#e.fps))-this.#s,n=i+this.#i,r=this.#i>this.#e.outFrame||this.#i<this.#e.inFrame,o=n>this.#e.outFrame||n<this.#e.inFrame,a=o&&!r;return this.#a>0&&!a?o?{nextFrame:this.#e.inFrame,framesToAdvance:i,ended:a}:{nextFrame:n,framesToAdvance:i,ended:a}:o?{nextFrame:this.#e.outFrame,framesToAdvance:i,ended:a}:{nextFrame:n,framesToAdvance:i,ended:a}}#b(){this.#c=document.visibilityState==="hidden",this.#m&&(this.stop(),this.play())}};import{Composition as W}from"remotion";import{NoReactInternals as S}from"remotion/no-react";function M({src:g,compositionWidth:t,compositionHeight:e,fps:i,durationInFrames:n,initialFrame:r,inFrame:o,outFrame:a,numberOfSharedAudioTags:E}){}var $=S.validateFps,V=S.validateDimension,N=S.validateDurationInFrames;var C=class{$$PROVIDER_TYPE="REMOTION";scope=v();#e=d(null);#h=!1;#d=!1;#l=null;#i=d(!1);#s=null;#a=d([]);#m=d([]);#r=new Set;#u=null;#o=d({[u]:0});#c=new T;#n=null;#f;#t;#y;#b={setMediaMuted:this.setMuted.bind(this),setMediaVolume:this.setVolume.bind(this)};get type(){return"remotion"}get currentSrc(){return m(this.#e)}get frame(){return this.#o()}constructor(t,e){this.#f=t,this.#t=e,this.#y={setFrame:this.#p.bind(this),setPlaying:this.#S.bind(this)},this.#c.setContainer(t)}setup(){y(this.#_.bind(this)),y(this.#v.bind(this)),y(this.#F.bind(this))}#v(){this.#a(),this.#g()}#g(){let t=[...this.#f.querySelectorAll("audio,video")];this.#m.set(t)}#F(){let t=this.#m();for(let e of t){let i=this.#R.bind(this,e),n=this.#w.bind(this,e);e.currentSrc&&e.readyState<4&&(this.#R(e),c(e,"canplay",n)),c(e,"waiting",i),c(e,"playing",n)}for(let e of this.#r)t.includes(e)||this.#w(e)}#k(t){let{inFrame:e,fps:i}=this.#e(),{seeking:n}=this.#t.$state,r=Math.max(0,t-e)/i;this.#o.set(o=>({...o,[u]:t})),this.#t.notify("time-change",r),n()&&(p(),this.#t.notify("seeked",r))}#T(){this.pause(),this.#t.notify("end")}async play(){let{ended:t}=this.#t.$state;m(t)&&this.#p({[u]:0});try{let e=m(this.#m);if(e.length&&await Promise.all(e.map(i=>i.play())),this.#t.notify("play"),p(),this.#s)return this.#t.notify("waiting"),this.#s.promise;this.#n?.play(),this.#t.notify("playing")}catch(e){throw e}}async pause(){let{paused:t}=this.#t.$state;this.#n?.stop(),this.#t.notify("pause")}setMuted(t){if(!this.#t)return;let{muted:e,volume:i}=this.#t.$state;if(l(t)){this.setMuted(t(e()));return}this.#t.notify("volume-change",{volume:m(i),muted:t})}setCurrentTime(t){let{fps:e}=this.#e(),i=t*e;this.#t.notify("seeking",t),this.#p({[u]:i})}setVolume(t){if(!this.#t)return;let{volume:e,muted:i}=this.#t.$state;if(l(t)){this.setVolume(t(e()));return}this.#t.notify("volume-change",{volume:t,muted:m(i)})}setPlaybackRate(t){if(l(t)){let{playbackRate:e}=this.#t.$state;this.setPlaybackRate(t(m(e)));return}this.#n?.setPlaybackRate(t),this.#t.notify("rate-change",t)}async loadSource(t){if(!w(t))return;let e=t.onError,i={compositionWidth:1920,compositionHeight:1080,fps:30,initialFrame:0,inFrame:0,outFrame:t.durationInFrames,numberOfSharedAudioTags:5,inputProps:{},...t,onError:n=>{this.pause(),this.#t.notify("error",{message:n.message,code:1}),e?.(n)}};this.#e.set(i);for(let n of Object.keys(i))t[n]=i[n];this.changeSrc(i)}destroy(){this.changeSrc(null)}changeSrc(t){this.#n?.destroy(),this.#i.set(!1),this.#s?.reject("src changed"),this.#s=null,this.#l=null,this.#u=null,this.#n=null,this.#a.set([]),this.#r.clear(),this.#o.set({[u]:0}),this.#c.setSrc(t),t&&(this.#u=this.#x(),this.#n=new b(t,this.#k.bind(this),this.#T.bind(this)))}render=()=>{let t=h(this.#e);if(!t)throw Error("[vidstack] no src");s.useEffect(()=>{if(!w(t))return;M(t);let a=requestAnimationFrame(()=>{this.#h||(this.#t.notify("provider-setup",this),this.#h=!0),this.#d||(this.#t.notify("load-start"),this.#d=!0),this.#g(),p(),this.#i()||this.#E(t)});return()=>{cancelAnimationFrame(a),this.#d=!1}},[t]);let e=f.useLazyComponent({component:t.src}),{$state:i}=this.#t,n=h(i.volume),r=h(i.muted),o=s.useMemo(()=>{let{muted:a,volume:E}=this.#t.$state;return{mediaMuted:a(),mediaVolume:E()}},[r,n]);return s.createElement(_,{src:t,component:e,timeline:this.#u,mediaVolume:o,setMediaVolume:this.#b},s.createElement(f.Timeline.SetTimelineContext.Provider,{value:this.#y},s.createElement(this.renderVideo,{src:t})))};renderVideo=({src:t})=>{let e=f.useVideo(),i=e?e.component:null,n=s.useContext(f.SharedAudioContext),{$state:r}=this.#t;h(this.#o),h(r.playing),h(r.playbackRate),s.useEffect(()=>(this.#l=n,()=>{this.#l=null}),[n]);let o=s.useMemo(()=>t.renderLoading?.(),[t]),a=i?s.createElement(x,{fallback:t.errorFallback,onError:t.onError},s.createElement(f.ClipComposition,null,s.createElement(i,{...e?.props,...t.inputProps}))):null;return s.createElement(s.Suspense,{fallback:o},a)};#E(t){if(!t)return;let{outFrame:e,inFrame:i,fps:n}=t,r=(e-i)/n;this.#t.notify("loaded-metadata"),this.#t.notify("loaded-data"),this.#t.delegate.ready({duration:r,seekable:new R(0,r),buffered:new R(0,r)}),t.initialFrame&&this.#p({[u]:t.initialFrame})}#R(t){this.#r.add(t),this.#i.set(!0),this.#s||(this.#s=k())}#w(t){if(this.#r.delete(t),this.#r.size)return;this.#i.set(!1),this.#s?.resolve(),this.#s=null;let{canPlay:e}=this.#t.$state;m(e)||this.#E(m(this.#e))}#_(){this.#i();let{paused:t}=this.#t.$state;m(t)||(this.#i()?(this.#n?.stop(),this.#t.notify("waiting")):(this.#n?.play(),this.#t.notify("playing")))}#p(t){if(l(t)){this.#p(t(this.#o()));return}this.#o.set(i=>({...i,...t}));let e=t[u];this.#n&&this.#n.frame!==e&&(this.#n.frame=e)}#S(t){let{playing:e}=this.#t.$state;if(l(t)){this.#S(t(e()));return}t?this.play():t||this.pause()}#x(){let{playing:t,playbackRate:e}=this.#t.$state,i=this.#o,n=this.#a,r=this.setPlaybackRate.bind(this);return{rootId:u,get frame(){return i()},get playing(){return t()},get playbackRate(){return e()},imperativePlaying:{get current(){return t()}},setPlaybackRate:r,audioAndVideoTags:{get current(){return n()},set current(o){n.set(o)}}}}};export{C as RemotionProvider};
